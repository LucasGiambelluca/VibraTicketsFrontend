<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API VibraTicket</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test API VibraTicket</h1>
    
    <div class="section">
        <h2>1. Test Backend Health</h2>
        <button onclick="testHealth()">Test Health</button>
        <div id="health-result"></div>
    </div>

    <div class="section">
        <h2>2. Test Create Hold</h2>
        <button onclick="testCreateHold()">Create Hold</button>
        <div id="hold-result"></div>
    </div>

    <div class="section">
        <h2>3. Test Create Order</h2>
        <input type="text" id="holdId" placeholder="Hold ID" value="1">
        <button onclick="testCreateOrder()">Create Order</button>
        <div id="order-result"></div>
    </div>

    <div class="section">
        <h2>4. Test Simulate Payment</h2>
        <input type="text" id="orderId" placeholder="Order ID" value="1">
        <button onclick="testSimulatePayment()">Simulate Payment</button>
        <div id="payment-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        function uuid() {
            return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now();
        }

        async function apiCall(endpoint, options = {}) {
            try {
                console.log('üöÄ Calling:', endpoint, options);
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                console.log('üì¶ Response:', data);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || data.error}`);
                }

                return data;
            } catch (error) {
                console.error('‚ùå Error:', error);
                throw error;
            }
        }

        async function testHealth() {
            const resultDiv = document.getElementById('health-result');
            try {
                resultDiv.innerHTML = '<p>‚è≥ Testing...</p>';
                const result = await apiCall('/events');
                resultDiv.innerHTML = `<p class="success">‚úÖ Backend OK - ${result.events?.length || 0} events found</p>`;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testCreateHold() {
            const resultDiv = document.getElementById('hold-result');
            try {
                resultDiv.innerHTML = '<p>‚è≥ Creating hold...</p>';
                
                const holdData = {
                    showId: 1,  // Show 1 tiene asientos disponibles
                    seatIds: [801, 802],  // IDs de asientos reales del show 1
                    customerEmail: 'test@example.com',
                    customerName: 'Test User'
                };

                console.log('üì¶ Hold data to send:', holdData);
                const jsonString = JSON.stringify(holdData);
                console.log('üìÑ JSON string:', jsonString);

                const result = await apiCall('/holds', {
                    method: 'POST',
                    headers: {
                        'Idempotency-Key': `hold-${uuid()}`
                    },
                    body: jsonString
                });

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Hold created!</p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
                
                // Auto-fill hold ID for order test
                document.getElementById('holdId').value = result.holdId || result.id;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                console.error('Hold creation error:', error);
            }
        }

        async function testCreateOrder() {
            const resultDiv = document.getElementById('order-result');
            const holdId = document.getElementById('holdId').value;
            
            try {
                resultDiv.innerHTML = '<p>‚è≥ Creating order...</p>';
                
                const orderData = {
                    holdId: parseInt(holdId)
                };

                const result = await apiCall('/orders', {
                    method: 'POST',
                    headers: {
                        'Idempotency-Key': `order-${uuid()}`
                    },
                    body: JSON.stringify(orderData)
                });

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Order created!</p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;

                // Auto-fill order ID for payment test
                document.getElementById('orderId').value = result.orderId || result.id;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testSimulatePayment() {
            const resultDiv = document.getElementById('payment-result');
            const orderId = document.getElementById('orderId').value;
            
            try {
                resultDiv.innerHTML = '<p>‚è≥ Simulating payment...</p>';
                
                const paymentData = {
                    orderId: parseInt(orderId),
                    customerEmail: 'test@example.com',
                    customerName: 'Test User'
                };

                const result = await apiCall('/test-payments/simulate-payment', {
                    method: 'POST',
                    body: JSON.stringify(paymentData)
                });

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Payment simulated!</p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
